{% extends "base.html" %}

{% block content %}
<div class="max-w-3xl mx-auto px-4 py-8">
    <div class="relative mb-[-75px]">
        {% if user.header_path %}
            <img src="{{ url_for('uploaded_file', filename=user.header_path) }}" alt="ãƒ˜ãƒƒãƒ€ãƒ¼ç”»åƒ" class="w-full h-48 object-cover rounded-t-lg shadow-md">
        {% else %}
            <div class="w-full h-48 bg-gradient-to-r from-kawaii-pink to-kawaii-purple rounded-t-lg"></div>
        {% endif %}
    </div>

    <div class="bg-white/95 backdrop-blur-lg rounded-lg shadow-xl p-8 border border-kawaii-lavender relative">
        <div class="absolute left-1/2 transform -translate-x-1/2 -top-20">
            {% if user.icon_path %}
                <img src="{{ url_for('uploaded_file', filename=user.icon_path) }}" alt="ã‚¢ã‚¤ã‚³ãƒ³" class="w-32 h-32 rounded-full border-4 border-white shadow-lg object-cover border border-gray-200">
            {% else %}
                <div class="w-32 h-32 rounded-full bg-gray-300 border-4 border-white shadow-lg flex items-center justify-center border border-gray-200">
                    <span class="text-gray-500 text-3xl">ğŸ‘¤</span>
                </div>
            {% endif %}
        </div>

        <div class="text-center mt-16 mb-2">
            <h2 class="text-3xl font-bold text-kawaii-dark">{{ user.name }}</h2>
            <p class="text-md text-kawaii-purple">{{ user.student_id }}</p>
        </div>

        <div class="flex justify-center space-x-6 my-4 text-kawaii-dark">
            <a href="#" onclick="openModal('followersModal')" class="text-center hover:opacity-75">
                <span class="font-bold text-lg" id="followers-count">{{ user.followers.count() }}</span>
                <span class="text-sm block">ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼</span>
            </a>
            <a href="#" onclick="openModal('followingModal')" class="text-center hover:opacity-75">
                <span class="font-bold text-lg" id="following-count">{{ user.followed.count() }}</span>
                <span class="text-sm block">ãƒ•ã‚©ãƒ­ãƒ¼ä¸­</span>
            </a>
        </div>
        <div class="mb-8 p-4 bg-gray-50 rounded-lg">
            <h3 class="font-bold text-kawaii-dark mb-2">è‡ªå·±ç´¹ä»‹</h3>
            <p class="text-gray-700 whitespace-pre-wrap">{{ user.introduction or 'è‡ªå·±ç´¹ä»‹ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚' }}</p>
        </div>

        <div class="mb-8">
            <h3 class="font-bold text-kawaii-dark mb-2">ã‚¿ã‚°</h3>
            <div class="flex flex-wrap gap-2">
                {% if user.tags %}
                    {% for tag in user.tags.split(',') %}
                        {% if tag.strip() %}
                            <span class="bg-kawaii-purple/20 text-kawaii-purple text-sm font-medium px-3 py-1 rounded-full">{{ tag.strip() }}</span>
                        {% endif %}
                    {% endfor %}
                {% else %}
                    <p class="text-sm text-gray-500">ã‚¿ã‚°ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</p>
                {% endif %}
            </div>
        </div>

        <div class="border-t border-kawaii-lavender/50 pt-6 space-y-4">
            <p><span class="font-semibold text-kawaii-purple">æ ¡èˆ:</span> {{ user.school.school_name }}</p>
            <p><span class="font-semibold text-kawaii-purple">å­¦ç§‘:</span> {{ user.department.department_name if user.department else 'ãªã—' }}</p>
            <p><span class="font-semibold text-kawaii-purple">å­¦å¹´:</span> {{ user.year }}å¹´</p>
        </div>
        
        {% if not is_own_profile %}
        <div class="text-center mt-8 space-x-2" id="user-action-buttons">
            <button id="follow-btn" onclick="toggleFollow({{ user.user_id }})" 
                    class="inline-block font-bold py-2 px-6 rounded-full transition-colors
                           {% if is_following %}
                           bg-gray-200 text-gray-700 hover:bg-gray-300
                           {% else %}
                           bg-kawaii-pink text-white hover:bg-kawaii-purple
                           {% endif %}
                           {% if is_blocking %}hidden{% endif %}">
                {% if is_following %}ãƒ•ã‚©ãƒ­ãƒ¼ä¸­{% else %}ãƒ•ã‚©ãƒ­ãƒ¼ã™ã‚‹{% endif %}
            </button>
            <button onclick="openDmWindow({{ user.user_id }}, '{{ user.name }}', '{{ url_for('uploaded_file', filename=user.icon_path) if user.icon_path else '' }}')"
                    class="inline-block bg-kawaii-purple text-white font-bold py-2 px-6 rounded-full hover:bg-kawaii-purple transition-colors {% if is_blocking %}hidden{% endif %}">
                DMã‚’é€ã‚‹
            </button>
            <button id="block-btn" onclick="toggleBlock({{ user.user_id }})"
                    class="inline-block font-bold py-2 px-6 rounded-full transition-colors
                           {% if is_blocking %}
                           bg-red-500 text-white hover:bg-red-600
                           {% else %}
                           bg-gray-500 text-white hover:bg-gray-600
                           {% endif %}">
                {% if is_blocking %}ãƒ–ãƒ­ãƒƒã‚¯è§£é™¤{% else %}ãƒ–ãƒ­ãƒƒã‚¯{% endif %}
            </button>
        </div>
        {% elif is_own_profile %}
        <div class="text-center mt-8">
            <a href="{{ url_for('edit_profile') }}" class="inline-block bg-gray-200 text-gray-700 font-bold py-2 px-6 rounded-full hover:bg-gray-300 transition-colors">
                ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’ç·¨é›†
            </a>
        </div>
        {% endif %}
        </div>
</div>

<div id="followersModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50" onclick="closeModal('followersModal')">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6 relative" onclick="event.stopPropagation();">
        <h3 class="text-xl font-bold mb-4 text-kawaii-dark">ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼</h3>
        <button onclick="closeModal('followersModal')" class="absolute top-2 right-3 text-2xl text-gray-500 hover:text-gray-800">&times;</button>
        <ul id="follower-list" class="space-y-4 max-h-80 overflow-y-auto">
            {% for follower in user.followers %}
            <li id="follower-user-{{ follower.user_id }}">
                <a href="{{ url_for('profile_view', user_id=follower.user_id) }}" class="flex items-center space-x-3 group">
                    {% if follower.icon_path %}
                        <img src="{{ url_for('uploaded_file', filename=follower.icon_path) }}" alt="ã‚¢ã‚¤ã‚³ãƒ³" class="w-10 h-10 rounded-full object-cover">
                    {% else %}
                        <div class="w-10 h-10 rounded-full bg-gray-300 flex items-center justify-center"><span class="text-xl">ğŸ‘¤</span></div>
                    {% endif %}
                    <span class="text-kawaii-purple font-medium group-hover:underline">{{ follower.name }}</span>
                </a>
            </li>
            {% else %}
            <li id="no-followers-message" class="text-gray-500">ã¾ã ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼ãŒã„ã¾ã›ã‚“ã€‚</li>
            {% endfor %}
        </ul>
    </div>
</div>

<div id="followingModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50" onclick="closeModal('followingModal')">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6 relative" onclick="event.stopPropagation();">
        <h3 class="text-xl font-bold mb-4 text-kawaii-dark">ãƒ•ã‚©ãƒ­ãƒ¼ä¸­</h3>
        <button onclick="closeModal('followingModal')" class="absolute top-2 right-3 text-2xl text-gray-500 hover:text-gray-800">&times;</button>
        <ul class="space-y-4 max-h-80 overflow-y-auto">
            {% for followed_user in user.followed %}
            <li>
                <a href="{{ url_for('profile_view', user_id=followed_user.user_id) }}" class="flex items-center space-x-3 group">
                    {% if followed_user.icon_path %}
                        <img src="{{ url_for('uploaded_file', filename=followed_user.icon_path) }}" alt="ã‚¢ã‚¤ã‚³ãƒ³" class="w-10 h-10 rounded-full object-cover">
                    {% else %}
                        <div class="w-10 h-10 rounded-full bg-gray-300 flex items-center justify-center"><span class="text-xl">ğŸ‘¤</span></div>
                    {% endif %}
                    <span class="text-kawaii-purple font-medium group-hover:underline">{{ followed_user.name }}</span>
                </a>
            </li>
            {% else %}
            <li class="text-gray-500">èª°ã‚‚ãƒ•ã‚©ãƒ­ãƒ¼ã—ã¦ã„ã¾ã›ã‚“ã€‚</li>
            {% endfor %}
        </ul>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
<script>
// ãƒ¢ãƒ¼ãƒ€ãƒ«é–‹é–‰
function openModal(modalId) { document.getElementById(modalId).style.display = 'flex'; }
function closeModal(modalId) { document.getElementById(modalId).style.display = 'none'; }

// â–¼â–¼â–¼ã€ã“ã“ã‹ã‚‰JavaScriptã‚’å…¨é¢çš„ã«ä¿®æ­£ã€‘â–¼â–¼â–¼
// ãƒ•ã‚©ãƒ­ãƒ¼/ã‚¢ãƒ³ãƒ•ã‚©ãƒ­ãƒ¼å‡¦ç†
function toggleFollow(userId) {
    const isOwnProfile = {{ 'true' if is_own_profile else 'false' }};
    const currentUserId = {{ current_user_id }};

    fetch(`/follow/${userId}`, { 
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
    })
    .then(response => response.json())
    .then(data => {
        if (!data.success) {
            alert(data.message || 'å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
            return;
        }

        // --- DOMè¦ç´ ã‚’å–å¾— ---
        const followBtn = document.getElementById('follow-btn');
        const followersCountEl = document.getElementById('followers-count');
        const followingCountEl = document.getElementById('following-count');
        const followerList = document.getElementById('follower-list');

        // --- è¡¨ç¤ºã‚«ã‚¦ãƒ³ãƒˆã‚’æ›´æ–° ---
        followersCountEl.textContent = data.followers_count;
        if (isOwnProfile) {
            // è‡ªåˆ†ã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’è¦‹ã¦ã‚‹æ™‚ã ã‘è‡ªåˆ†ã®ãƒ•ã‚©ãƒ­ãƒ¼ä¸­ã‚«ã‚¦ãƒ³ãƒˆã‚’æ›´æ–°
            followingCountEl.textContent = data.following_count;
        }

        // --- ãƒ•ã‚©ãƒ­ãƒ¼ã—ãŸå ´åˆã®å‡¦ç† ---
        if (data.action === 'followed') {
            // ãƒœã‚¿ãƒ³ã®è¡¨ç¤ºã‚’ã€Œãƒ•ã‚©ãƒ­ãƒ¼ä¸­ã€ã«å¤‰æ›´
            followBtn.textContent = 'ãƒ•ã‚©ãƒ­ãƒ¼ä¸­';
            followBtn.classList.remove('bg-kawaii-pink', 'text-white', 'hover:bg-kawaii-purple');
            followBtn.classList.add('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300');

            // ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼ãƒªã‚¹ãƒˆã«è‡ªåˆ†ã‚’è¿½åŠ 
            const followerInfo = data.follower_info;
            const noFollowersMessage = document.getElementById('no-followers-message');
            if(noFollowersMessage) noFollowersMessage.remove();

            const newListItem = document.createElement('li');
            newListItem.id = `follower-user-${followerInfo.user_id}`;
            
            const iconHtml = followerInfo.icon_path
                ? `<img src="${followerInfo.icon_path}" alt="ã‚¢ã‚¤ã‚³ãƒ³" class="w-10 h-10 rounded-full object-cover">`
                : `<div class="w-10 h-10 rounded-full bg-gray-300 flex items-center justify-center"><span class="text-xl">ğŸ‘¤</span></div>`;

            newListItem.innerHTML = `
                <a href="/profile/${followerInfo.user_id}" class="flex items-center space-x-3 group">
                    ${iconHtml}
                    <span class="text-kawaii-purple font-medium group-hover:underline">${followerInfo.name}</span>
                </a>`;
            followerList.appendChild(newListItem);

        // --- ãƒ•ã‚©ãƒ­ãƒ¼è§£é™¤ã—ãŸå ´åˆã®å‡¦ç† ---
        } else { // 'unfollowed'
            // ãƒœã‚¿ãƒ³ã®è¡¨ç¤ºã‚’ã€Œãƒ•ã‚©ãƒ­ãƒ¼ã™ã‚‹ã€ã«å¤‰æ›´
            followBtn.textContent = 'ãƒ•ã‚©ãƒ­ãƒ¼ã™ã‚‹';
            followBtn.classList.remove('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300');
            followBtn.classList.add('bg-kawaii-pink', 'text-white', 'hover:bg-kawaii-purple');
            
            // ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼ãƒªã‚¹ãƒˆã‹ã‚‰è‡ªåˆ†ã‚’å‰Šé™¤
            const userToRemove = document.getElementById(`follower-user-${currentUserId}`);
            if (userToRemove) userToRemove.remove();
            
            // ãƒªã‚¹ãƒˆãŒç©ºã«ãªã£ãŸã‹ãƒã‚§ãƒƒã‚¯
            if (followerList.children.length === 0) {
                 const emptyMessage = document.createElement('li');
                 emptyMessage.id = 'no-followers-message';
                 emptyMessage.className = 'text-gray-500';
                 emptyMessage.textContent = 'ã¾ã ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼ãŒã„ã¾ã›ã‚“ã€‚';
                 followerList.appendChild(emptyMessage);
            }
        }
    }).catch(error => console.error('Error:', error));
}


// ğŸ”½ è¿½åŠ : ãƒ–ãƒ­ãƒƒã‚¯/ãƒ–ãƒ­ãƒƒã‚¯è§£é™¤å‡¦ç†
function toggleBlock(userId) {
    fetch(`/block/${userId}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
    })
    .then(response => response.json())
    .then(data => {
        if (!data.success) {
            alert(data.message || 'å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
            return;
        }

        // æˆåŠŸã—ãŸã‚‰ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦çŠ¶æ…‹ã‚’å®Œå…¨ã«åæ˜ ã•ã›ã‚‹
        // (UIã®è¦ç´ ãŒå¤šãè¤‡é›‘ãªãŸã‚ã€ãƒªãƒ­ãƒ¼ãƒ‰ãŒæœ€ã‚‚ç¢ºå®Ÿ)
        alert(data.message);
        window.location.reload();
    })
    .catch(error => {
        console.error('Error:', error);
        alert('ãƒ–ãƒ­ãƒƒã‚¯å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
    });
}
// ğŸ”¼ è¿½åŠ å®Œäº†
</script>
{% endblock %}