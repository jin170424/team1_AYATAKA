{% extends "base.html" %}

{% block content %}
<div class="max-w-3xl mx-auto px-4 py-8">
    <div class="relative mb-[-75px]">
        {% if user.header_path %}
            <img src="{{ url_for('uploaded_file', filename=user.header_path) }}" alt="„Éò„ÉÉ„ÉÄ„ÉºÁîªÂÉè" class="w-full h-48 object-cover rounded-t-lg shadow-md">
        {% else %}
            <div class="w-full h-48 bg-gradient-to-r from-kawaii-pink to-kawaii-purple rounded-t-lg"></div>
        {% endif %}
    </div>

    <div class="bg-white/95 backdrop-blur-lg rounded-lg shadow-xl p-8 border border-kawaii-lavender relative">
        <div class="absolute left-1/2 transform -translate-x-1/2 -top-20">
            {% if user.icon_path %}
                <img src="{{ url_for('uploaded_file', filename=user.icon_path) }}" alt="„Ç¢„Ç§„Ç≥„É≥" class="w-32 h-32 rounded-full border-4 border-white shadow-lg object-cover border border-gray-200">
            {% else %}
                <div class="w-32 h-32 rounded-full bg-gray-300 border-4 border-white shadow-lg flex items-center justify-center border border-gray-200">
                    <span class="text-gray-500 text-3xl">üë§</span>
                </div>
            {% endif %}
        </div>

        <div class="text-center mt-16 mb-2">
            <h2 class="text-3xl font-bold text-kawaii-dark">{{ user.name }}</h2>
            <p class="text-md text-kawaii-purple">{{ user.student_id }}</p>
        </div>

        <div class="flex justify-center space-x-6 my-4 text-kawaii-dark">
            <a href="#" onclick="openModal('followersModal')" class="text-center hover:opacity-75">
                <span class="font-bold text-lg" id="followers-count">{{ user.followers.count() }}</span>
                <span class="text-sm block">„Éï„Ç©„É≠„ÉØ„Éº</span>
            </a>
            <a href="#" onclick="openModal('followingModal')" class="text-center hover:opacity-75">
                <span class="font-bold text-lg">{{ user.followed.count() }}</span>
                <span class="text-sm block">„Éï„Ç©„É≠„Éº‰∏≠</span>
            </a>
        </div>
        <div class="mb-8 p-4 bg-gray-50 rounded-lg">
            <h3 class="font-bold text-kawaii-dark mb-2">Ëá™Â∑±Á¥π‰ªã</h3>
            <p class="text-gray-700 whitespace-pre-wrap">{{ user.introduction or 'Ëá™Â∑±Á¥π‰ªã„ÅåË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ' }}</p>
        </div>

        <div class="mb-8">
            <h3 class="font-bold text-kawaii-dark mb-2">„Çø„Ç∞</h3>
            <div class="flex flex-wrap gap-2">
                {% if user.tags %}
                    {% for tag in user.tags.split(',') %}
                        {% if tag.strip() %}
                            <span class="bg-kawaii-purple/20 text-kawaii-purple text-sm font-medium px-3 py-1 rounded-full">{{ tag.strip() }}</span>
                        {% endif %}
                    {% endfor %}
                {% else %}
                    <p class="text-sm text-gray-500">„Çø„Ç∞„ÅåË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ</p>
                {% endif %}
            </div>
        </div>

        <div class="border-t border-kawaii-lavender/50 pt-6 space-y-4">
            <p><span class="font-semibold text-kawaii-purple">Ê†°Ëàé:</span> {{ user.school.school_name }}</p>
            <p><span class="font-semibold text-kawaii-purple">Â≠¶Áßë:</span> {{ user.department.department_name if user.department else '„Å™„Åó' }}</p>
            <p><span class="font-semibold text-kawaii-purple">Â≠¶Âπ¥:</span> {{ user.year }}Âπ¥</p>
        </div>
        
        {% if not is_own_profile %}
        <div class="text-center mt-8">
            <button id="follow-btn" onclick="toggleFollow({{ user.user_id }})" 
                    class="inline-block font-bold py-2 px-6 rounded-full transition-colors
                           {% if is_following %}
                           bg-gray-200 text-gray-700 hover:bg-gray-300
                           {% else %}
                           bg-kawaii-pink text-white hover:bg-kawaii-purple
                           {% endif %}">
                {% if is_following %}
                „Éï„Ç©„É≠„Éº‰∏≠
                {% else %}
                „Éï„Ç©„É≠„Éº„Åô„Çã
                {% endif %}
            </button>
        </div>
        {% elif is_own_profile %}
        <div class="text-center mt-8">
            <a href="{{ url_for('edit_profile') }}" class="inline-block bg-gray-200 text-gray-700 font-bold py-2 px-6 rounded-full hover:bg-gray-300 transition-colors">
                „Éó„É≠„Éï„Ç£„Éº„É´„ÇíÁ∑®ÈõÜ
            </a>
        </div>
        {% endif %}
        </div>
</div>

<div id="followersModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50" onclick="closeModal('followersModal')">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6 relative" onclick="event.stopPropagation();">
        <h3 class="text-xl font-bold mb-4 text-kawaii-dark">„Éï„Ç©„É≠„ÉØ„Éº</h3>
        <button onclick="closeModal('followersModal')" class="absolute top-2 right-3 text-2xl text-gray-500 hover:text-gray-800">&times;</button>
        <ul class="space-y-4 max-h-80 overflow-y-auto">
            {% for follower in user.followers %}
            <li>
                <a href="{{ url_for('profile_view', user_id=follower.user_id) }}" class="flex items-center space-x-3 group">
                    {% if follower.icon_path %}
                        <img src="{{ url_for('uploaded_file', filename=follower.icon_path) }}" alt="„Ç¢„Ç§„Ç≥„É≥" class="w-10 h-10 rounded-full object-cover">
                    {% else %}
                        <div class="w-10 h-10 rounded-full bg-gray-300 flex items-center justify-center"><span class="text-xl">üë§</span></div>
                    {% endif %}
                    <span class="text-kawaii-purple font-medium group-hover:underline">{{ follower.name }}</span>
                </a>
            </li>
            {% else %}
            <li class="text-gray-500">„Åæ„Å†„Éï„Ç©„É≠„ÉØ„Éº„Åå„ÅÑ„Åæ„Åõ„Çì„ÄÇ</li>
            {% endfor %}
        </ul>
    </div>
</div>

<div id="followingModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50" onclick="closeModal('followingModal')">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6 relative" onclick="event.stopPropagation();">
        <h3 class="text-xl font-bold mb-4 text-kawaii-dark">„Éï„Ç©„É≠„Éº‰∏≠</h3>
        <button onclick="closeModal('followingModal')" class="absolute top-2 right-3 text-2xl text-gray-500 hover:text-gray-800">&times;</button>
        <ul class="space-y-4 max-h-80 overflow-y-auto">
            {% for followed_user in user.followed %}
            <li>
                <a href="{{ url_for('profile_view', user_id=followed_user.user_id) }}" class="flex items-center space-x-3 group">
                    {% if followed_user.icon_path %}
                        <img src="{{ url_for('uploaded_file', filename=followed_user.icon_path) }}" alt="„Ç¢„Ç§„Ç≥„É≥" class="w-10 h-10 rounded-full object-cover">
                    {% else %}
                        <div class="w-10 h-10 rounded-full bg-gray-300 flex items-center justify-center"><span class="text-xl">üë§</span></div>
                    {% endif %}
                    <span class="text-kawaii-purple font-medium group-hover:underline">{{ followed_user.name }}</span>
                </a>
            </li>
            {% else %}
            <li class="text-gray-500">Ë™∞„ÇÇ„Éï„Ç©„É≠„Éº„Åó„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ</li>
            {% endfor %}
        </ul>
    </div>
</div>

<script>
// „É¢„Éº„ÉÄ„É´ÈñãÈñâ
function openModal(modalId) { document.getElementById(modalId).style.display = 'flex'; }
function closeModal(modalId) { document.getElementById(modalId).style.display = 'none'; }

// „Éï„Ç©„É≠„Éº/„Ç¢„É≥„Éï„Ç©„É≠„ÉºÂá¶ÁêÜ
function toggleFollow(userId) {
    fetch(`/follow/${userId}`, { 
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const followBtn = document.getElementById('follow-btn');
            const followersCount = document.getElementById('followers-count');
            
            followersCount.textContent = data.followers_count;

            if (data.action === 'followed') {
                followBtn.textContent = '„Éï„Ç©„É≠„Éº‰∏≠';
                followBtn.classList.remove('bg-kawaii-pink', 'text-white', 'hover:bg-kawaii-purple');
                followBtn.classList.add('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300');
            } else {
                followBtn.textContent = '„Éï„Ç©„É≠„Éº„Åô„Çã';
                followBtn.classList.remove('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300');
                followBtn.classList.add('bg-kawaii-pink', 'text-white', 'hover:bg-kawaii-purple');
            }
        } else {
            // „Ç®„É©„Éº„É°„ÉÉ„Çª„Éº„Ç∏„Çí„Ç¢„É©„Éº„Éà„Å™„Å©„ÅßË°®Á§∫
            alert(data.message);
        }
    }).catch(error => console.error('Error:', error));
}
</script>
{% endblock %}